<!doctype html>
<html class="no-js">
<head>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <title>Gestión de residuos sólidos urbanos en la Región Metropolitana de Buenos Aires</title>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
	<link href="css/style.css" rel="stylesheet" type="text/css" />
	<link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />	
	<link href='http://fonts.googleapis.com/css?family=Ropa+Sans' rel='stylesheet' type='text/css'>	
	<link href='http://fonts.googleapis.com/css?family=Raleway:700' rel='stylesheet' type='text/css'>
    <script type="text/javascript" src="lib/d3.v2.min.js"></script>
	<script type="text/javascript" src="lib/colorbrewer.js"></script>
    <script type="text/javascript" src="lib/topojson.js"></script>
    <script type="text/javascript" src="lib/cartogram.js"></script>
    <script type="text/javascript" src="lib/tooltip.js"></script>   
	<script type="text/javascript" src="lib/bootstrap/js/bootstrap.min.js"></script> 
   </head>
     <body>
<div class="row">
	<div class="col-lg-12">
		<table width="100%">
			<tr>
				<td background="img/header.jpg" align="center">
					<h2 class="title">Gestión de residuos sólidos urbanos en la Región Metropolitana de Buenos Aires</h2>
					<br>
				</td>
			</tr>
		</table>
	</div>
</div>
<div class="row">
	<div class="col-lg-12">
		<div class="btn-group btn-group-lg btn-group-justified" role="group" aria-label="...">
			<div class="btn-group btn-group-lg" role="group">
				<button type="button" class="btn btn-brown">Acerca de</button>
			</div>
			<div class="btn-group btn-group-lg" role="group">
				<button type="button" class="btn btn-brown">Menu</button>
			</div>
			<div class="btn-group btn-group-lg" role="group">
				<button type="button" class="btn btn-brown">Contacto</button>
			</div>
			<div class="btn-group" role="group">
				<button type="button" class="btn btn-brown"><img src="img/social_icons.png" width="140"></button>
			</div>
		</div>
	</div>
</div>
<div class="row">
	<div class="col-xs-2">
			<div class="btn-group-vertical" role="group" aria-label="...">
			    <button type="button" class="btn btn-brown">Variable1</button>
			    <button type="button" class="btn btn-brown">Variable2</button>
				<button type="button" class="btn btn-brown">Variable3</button>
				<button type="button" class="btn btn-brown">Variable4</button>						
				<button type="button" class="btn btn-brown">Variable5</button>
				<button type="button" class="btn btn-brown">Variable6</button>
				<button type="button" class="btn btn-brown">Variable7</button>
			</div>
			<div id="tooltip_div">
			</div>
	</div>
	<div class="col-xs-5">
		<div id="container">
			<div id="map-container">
				<svg id="map"></svg>
			</div>
		</div>
	</div>
	<div class="col-xs-5">
		<img src="img/chartmock.png" width="400">
	</div>
</div>
<div class="row">
	<div class="col-xs-4" align="center">
		<button type="button" class="btn btn-brown">Créditos</button>
	</div>
	<div class="col-xs-4" align="center">
		<button type="button" class="btn btn-brown">Descargar</button>
	</div>
</div>
    <script>

      var width = 480,
    	  height = 640,
          active;
	
      if (!document.createElementNS) {
        document.getElementsById("map").style.display = "none";
      }

      var pordiezmil = (function() {
           var fmt = d3.format(".1f");
           return function(n) { return fmt(n) + " / 10 mil"; ; };
          })()
      var pormil = (function() {
           var fmt = d3.format(".1f");
           return function(n) { return fmt(n) + " por mil"; ; };
          })()
      var bolivianos = (function() {
           var fmt = d3.format(",");
           return function(n) { return "$ " + fmt(n); };
          })()		  
      var porcien = (function() {
           var fmt = d3.format(".1f");
           return function(n) { return fmt(n) + "%"; };
          })(),

          fields = [

	{name: "(no scale)", id: "none"},
	{name: "Población", id: "censo", key: "CENSO%d", format: ","},

          ],

          years = [101, 102],
          fieldsById = d3.nest()
            .key(function(d) { return d.id; })
            .rollup(function(d) { return d[0]; })
            .map(fields),
          field = fields[0],
          year = years[0],
          colors = colorbrewer.Andy[3]
            .reverse()
            .map(function(rgb) { return d3.hsl(rgb); });

      var body = d3.select("body"),
          stat = d3.select("#status");

      var fieldSelect = d3.select("#field")
        .on("change", function(e) {
          field = fields[this.selectedIndex];
          location.hash = "#" + [field.id, year].join("/");
        });

      fieldSelect.selectAll("option")
        .data(fields)
        .enter()
        .append("option")
          .attr("value", function(d) { return d.id; })
          .text(function(d) { return d.name; });

      var yearSelect = d3.select("#year")
        .on("change", function(e) {
          year = years[this.selectedIndex];
          location.hash = "#" + [field.id, year].join("/");
        });

      yearSelect.selectAll("option")
        .data(years)
        .enter()
        .append("option")
          .attr("value", function(y) { return y; })
          .text(function(y) { return y; })

		  var map = d3.select("#map"),
          zoom = d3.behavior.zoom()
            .translate([15610, -9980])
            .scale(1)
            .scaleExtent([0.5, 10.0])
            .on("zoom", updateZoom),
          layer = map.append("g")
            .attr("id", "layer"),
          states = layer.append("g")
            .attr("id", "states")
            .selectAll("path");

      // map.call(zoom);
      updateZoom();

      function updateZoom() {
        var scale = zoom.scale();
        layer.attr("transform",
          "translate(" + zoom.translate() + ") " +
          "scale(" + [scale, scale] + ")");
      }

      var proj = d3.geo.mercator()

    .scale(97500),
          topology,
          geometries,
          rawData,
          dataById = {},
          carto = d3.cartogram()
            .projection(proj)
            .properties(function(d) {
              return dataById[d.id];
            })
            .value(function(d) {
              return +d.properties[field];
            });

      window.onhashchange = function() {
        parseHash();
      };

      var segmentized = location.search === "?segmentized",
          url = ["data",
            segmentized ? "argentina-provincias-segmentized.topojson" : "buenosaires-conurbano.topojson"
          ].join("/");
      d3.json(url, function(topo) {
        topology = topo;
        geometries = topology.objects.states.geometries;
        d3.tsv("data/buenosaires-conurbano.csv", function(data) {
          rawData = data;
          dataById = d3.nest()
            .key(function(d) { return d.NAME; })
            .rollup(function(d) { return d[0]; })
            .map(data);
          init();

        });
      });      function init() {
        var features = carto.features(topology, geometries),
            path = d3.geo.path()
              .projection(proj);

        states = states.data(features)
          .enter()
          .append("path")
            .attr("class", "state")
	    .attr("fill", "#E3E1D0")
            .attr("d", path)
			.on("click", click);	

        
		parseHash();	

      }


			
      function reset() {
	  
		d3.selectAll(".active").classed("active", false);

        stat.text("");
        body.classed("updating", false);
		
        var features = carto.features(topology, geometries),
            path = d3.geo.path()
              .projection(proj);

			  
        states.data(features)
          .transition()
            .duration(1250)
	    .attr("transform", "")
            .ease("linear")
            .attr("fill", "#E3E1D0")
            .attr("d", path);

        states.data(features)
        .call(d3.helper.tooltip_custom(function(d, i)
		{return [d.properties.NOMBRE + "<br>Datos del municipio<br><small>10.0343</small><br><br><small>data</small><br><br><small>data</small><br><br><small>data</small><br>"];}));
			
        states.select("title")

          .text(function(d) {
            return d.properties.NAME;
          });
		  

      }



      function update() {
	  
        var start = Date.now();
        body.classed("updating", true);

        var key = field.key.replace("%d", year),
            fmt = (typeof field.format === "function")
              ? field.format
              : d3.format(field.format || ","),
            value = function(d) {
              return +d.properties[key];
            }
			valueX = function(d) {
              return +d.properties["X"+key];
            },

            values = states.data()
              .map(value)
              .filter(function(n) {
                return !isNaN(n);
              })
              .sort(d3.ascending),
            lo = values[0],
            hi = values[values.length - 1];

            valuesX = states.data()
              .map(valueX)
              .filter(function(n) {
                return !isNaN(n);
              })
              .sort(d3.ascending),
            loX = valuesX[0],
            hiX = valuesX[valuesX.length - 1];			

		document.getElementById('div_min').innerHTML="<p class=\"descriptionhome-subtitle\"><font color=Black> "+fmt(loX)+"%</font></p>";
		document.getElementById('div_max').innerHTML="<p class=\"descriptionhome-subtitle\"><font color=Black> "+fmt(hiX)+"%</font></p>";	
			
        var color = d3.scale.linear()
          .range(colors)
          .domain(loX < 0
            ? [loX, 0, hiX]
            : [loX, d3.mean(valuesX), hiX]);

        // normalize the scale to positive numbers
        var scale = d3.scale.linear()
          .domain([lo, hi])
          .range([1, 100]);

        // tell the cartogram to use the scaled values
        carto.value(function(d) {
          return scale(value(d));
        });

		//valores = String(values);
		//alert(valores);
		//valores = valores.replace(".", ",");
		//alert(valores);
		

        // generate the new features, pre-projected


        var features = carto(topology, geometries).features;

		states.data(features).on("click", click2);
		
        // update the data
        states.data(features)
					.on("click", click)
        .call(d3.helper.tooltip_custom(function(d, i)
		{return [d.properties.NOMBRE + "<br>" + fmt(value(d)) + " (" + fmt(valueX(d)) + "%)"];}));

		
        states.transition()
          .duration(1750)
          .ease("linear")
          .attr("fill", function(d) {
            return color(valueX(d));
          })
          .attr("d", carto.path);


		  
        var delta = (Date.now() - start) / 1000;
        stat.text([" ", delta.toFixed(1), " "].join(" "));
        body.classed("actualizando", false);
		

	
      }

	  
	  
      var deferredUpdate = (function() {
        var timeout;
        return function() {
          var args = arguments;
          clearTimeout(timeout);
          stat.text(" ");
          return timeout = setTimeout(function() {
            update.apply(null, arguments);
          }, 10);
        };
		

      })();

      var hashish = d3.selectAll("a.hashish")
        .datum(function() {
          return this.href;
        });

      function parseHash() {
        var parts = location.hash.substr(1).split("/"),
            desiredFieldId = parts[0],
            desiredYear = +parts[1];

        field = fieldsById[desiredFieldId] || fields[0];
        year = (years.indexOf(desiredYear) > -1) ? desiredYear : years[0];

        fieldSelect.property("selectedIndex", fields.indexOf(field));

        if (field.id === "none") {

          yearSelect.attr("disabled", "disabled");
          reset();

        } else {

          if (field.years) {
            if (field.years.indexOf(year) === -1) {
              year = field.years[0];
            }
            yearSelect.selectAll("option")
              .attr("disabled", function(y) {
                return (field.years.indexOf(y) === -1) ? "disabled" : null;
              });
          } else {
            yearSelect.selectAll("option")
              .attr("disabled", null);
          }

          yearSelect
            .property("selectedIndex", years.indexOf(year))
            .attr("disabled", null);

          deferredUpdate();
          location.replace("#" + [field.id, year].join("/"));

          hashish.attr("href", function(href) {
            return href + location.hash;
          });
        }

	

      }

	// pour la gallerie
	  
	function click2()
	  { cambio = 1; }
	 
	function valoresComa()
	  {var valore = value(d);
	  alert(valore);}
	  
	function setCambio() { 
	cambio = 0;

	var features = carto(topology, geometries).features;
	
	states.data(features)
	    .on("click", click);	  

}

	  
 	function blank() {
			
	// des-seleccionar provincias
			
 	d3.selectAll(".active").classed("active", false);
			
	// zoom out cuando click en una provincia
	states.transition().duration(750).attr("transform", "");
			  
	// des-seleccionar provincia activa
	d3.select(this).classed("active", active = 0);
}

 	function click(d) {	

	d3.selectAll(".active").tooltip_custom.style("visibility", "visible");
	}
	
 	function click3(d) {


     	if (active === d) return blank();
	   d3.selectAll(".active").classed("active", false);
	   d3.select(this).classed("active", active = d);

        var b = d3.geo.bounds(d);
   
  	states.transition()
  		.duration(750)
  		.attr("transform",
      		"translate(" + proj.translate() + ")"
      		+ "scale(" + .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height) + ")"
      		+ "translate(" + -(b[1][0] + b[0][0]) / 3.5 + "," + -(b[1][1] + b[0][1]) / 3.5 + ")")

}

</script>
  </body>
</html>